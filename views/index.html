<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Shortner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <style>
        </style>
</head>

<body>
    <div class="container">
        <div>
            <h1>URL Shortener</h1>
            <button class="signoutBtn" id="signoutBtn" onclick="actionSignout()">Sign Out</button>
        </div>
        <!-- <form action="/shortenUrl" method="post" class="my-4 form-inline"> -->
            <div class="form-group col">
            <!-- <label for="fullurl" class="sr-only">Url</label> -->
            <input type="url" placeholder="URL" required name="fullurl" id="fullurlInput" class="form-control col mr-2">
            <button type="button" class="btn btn-success" onclick="generateShortUrl()">Shrink</button>
        </div>
        <!-- </form> -->
        <table class="table table-striped table-responsive">
            <thead>
                <tr>
                    <th>Full URl</th>
                    <th>Short URl</th>
                    <th>Clicks</th>
                </tr>
            </thead>
            <tbody id="urlTable">
                <!-- <% for(var i=0;i < urls.length;i++ ){ %>
                <tr>
                    <td><a href="<%= urls[i].full %>"><%= urls[i].full%></a></td>
                    <td><a href="<%= urls[i].short %>"><%= urls[i].short%></a></td>
                    <td><%= urls[i].clicks%></td>
                </tr>
                <%}%> -->
            </tbody>
        </table>
    </div>
</body>
<script>
    window.onload = () => {
        token = window.localStorage.getItem("token");
        if(token){
            var http = new XMLHttpRequest();
            http.open("POST","/signin/check",true);
            let data = {
                "token": token
            }
            data = JSON.stringify(data);
            http.setRequestHeader('Content-type', 'application/json');
            http.onload =() => {
                if(http.status == 200){
                    getData();
                }
                else{
                    window.location.href = "/signin";
                }
            }
            http.send(data);
        }
        else{
            window.location.href = "/signin";
        }
    }
    function getData(){
        var http = new XMLHttpRequest();
        token = window.localStorage.getItem("token");
        // console.log(token);
        http.open("POST","/getdata",true);
        let data = {
            "token": token
        }
        data = JSON.stringify(data);
        http.setRequestHeader('Content-type', 'application/json');
        http.onload =() => {
            if(http.status == 200){
                data = JSON.parse(http.responseText)
                // console.log(data);
                renderData(data);
            }
            else{
                alert("Some Error Occured while loading data");
            }
        }
        http.send(data);
    }
    function renderData(data){
        var table = document.getElementById("urlTable");
        data.map((urls,index) => {
            var tr = document.createElement("tr");
            table.appendChild(tr);

            var td1 = document.createElement("td");
            tr.appendChild(td1);
            var link = document.createElement("a");
            link.href = urls.full;
            link.innerHTML = urls.full;
            td1.appendChild(link);

            var td2 = document.createElement("td");
            tr.appendChild(td2);
            var link2 = document.createElement("a");
            link2.href = urls.short;
            link2.innerHTML = urls.short;
            td2.appendChild(link2);

            var td3 = document.createElement("td");
            tr.appendChild(td3);
            td3.innerHTML = urls.clicks;
            // tr.innerHTML.appendChild(td1);
        })
        
    }

    function generateShortUrl() {
        var fullurl = document.getElementById("fullurlInput").value;
        var url = document.createElement('a');
        url.href = fullurl;
        // console.log(url.hostname);
        if(url.hostname != 'localhost' && url.hostname != ""){
            // console.log(fullurl);
            var http = new XMLHttpRequest();
            http.open('POST','/shortenUrl',true);
            let data = {
                "token": window.localStorage.getItem("token"),
                "fullurl": fullurl
            }
            data = JSON.stringify(data);
            http.setRequestHeader('Content-type', 'application/json');
            http.onload = () => {
                if(http.status == 200){
                    window.location.href = '/';
                    // console.log(http.responseText);
                }
                else{
                    alert("could not shorten the url Please Try Again!!");
                }
            }
            http.send(data);
        }
        else{
            alert("Enter a valid url");
        }
    }
    function actionSignout(){
        window.localStorage.clear();
        window.location.href = '/signin';
    }
</script>

</html>